version: 2

models:
  - name: stg_champindex
    description: >
      Silver staging view for Champion Index snapshots.
      Contains one row per owned champion per snapshot, enriched with
      standardized column names and audit metadata.
      Used as the upstream source for snapshot ordering and SCD2 processing.

    config:
      alias: silver_stg_champindex
      tags: ['contract']
      
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - account_name
              - owned_champion_id
              - source_file

      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - account_name
              - owned_champion_id
              - snapshot_date
              - snapshot_version

    columns:
      - name: account_name
        description: Account identifier the snapshot belongs to.
        tests:
          - not_null

      - name: owned_champion_id
        description: Unique identifier for the owned champion instance.
        tests:
          - not_null

      - name: champion_id
        description: Identifier for the champion type (shared across owned copies).
        tests:
          - not_null

      - name: champion_name
        description: Display name of the champion.
        tests:
          - not_null:
              config:
                severity: warn

      - name: rank
        description: Champion rank.
        tests:
          - not_null:
              config:
                severity: warn
          - accepted_values:
              arguments:
                values: [1, 2, 3, 4, 5, 6]
                config:
                  severity: warn

      - name: level
        description: Champion level.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "level >= 0"
                config:
                  severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "level <= rank * 10"
                config:
                  severity: warn

      - name: empower_level
        description: Champion empower level.
        tests:
          - not_null:
              config:
                severity: warn
          - accepted_values:
              arguments:
                values: [0, 1, 2, 3, 4]
                config:
                  severity: warn

      - name: rarity
        description: Champion rarity tier.
        tests:
          - not_null:
              config:
                severity: warn
          - accepted_values:
              arguments:
                values: [1, 2, 3, 4, 5, 6]
                config:
                  severity: warn

      - name: affinity
        description: Champion affinity.
        tests:
          - not_null:
              config:
                severity: warn
          - accepted_values:
              arguments:
                values: [1, 2, 3, 4]
                config:
                  severity: warn

      - name: faction
        description: Champion faction.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "faction between 1 and 18"
                config:
                  severity: warn

      - name: used_t1_mastery_scrolls
        description: Number of Tier 1 mastery scrolls used.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "used_t1_mastery_scrolls >= 0"
                config:
                  severity: warn

      - name: unused_t1_mastery_scrolls
        description: Number of unused Tier 1 mastery scrolls.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "unused_t1_mastery_scrolls >= 0"
                config:
                  severity: warn

      - name: used_t2_mastery_scrolls
        description: Number of Tier 2 mastery scrolls used.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "used_t2_mastery_scrolls >= 0"
                config:
                  severity: warn

      - name: unused_t2_mastery_scrolls
        description: Number of unused Tier 2 mastery scrolls.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "unused_t2_mastery_scrolls >= 0"
                config:
                  severity: warn

      - name: used_t3_mastery_scrolls
        description: Number of Tier 3 mastery scrolls used.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "used_t3_mastery_scrolls >= 0"
                config:
                  severity: warn

      - name: unused_t3_mastery_scrolls
        description: Number of unused Tier 3 mastery scrolls.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "unused_t3_mastery_scrolls >= 0"
                config:
                  severity: warn

      - name: hp
        description: Champion base HP stat.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "hp >= 0"
                config:
                  severity: warn

      - name: atk
        description: Champion base attack stat.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "atk >= 0"
                config:
                  severity: warn

      - name: def
        description: Champion base defense stat.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "def >= 0"
                config:
                  severity: warn

      - name: crit_rate
        description: Champion critical hit rate.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "crit_rate >= 0"
                config:
                  severity: warn

      - name: crit_damage
        description: Champion critical damage multiplier.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "crit_damage >= 0"
                config:
                  severity: warn

      - name: spd
        description: Champion speed stat.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "spd >= 0"
                config:
                  severity: warn

      - name: acc
        description: Champion accuracy stat.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "acc >= 0"
                config:
                  severity: warn

      - name: res
        description: Champion resistance stat.
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.expression_is_true:
              arguments:
                expression: "res >= 0"
                config:
                  severity: warn

      - name: blessing_id
        description: Identifier of the applied blessing.
        tests:
          - accepted_values:
              arguments:
                values: [0, 1, 2, 3, 4, 5, 6]
                config:
                  severity: warn

      - name: blessing_grade
        description: Grade or tier of the applied blessing.
        tests:
          - dbt_utils.expression_is_true:
              arguments:
                expression: "blessing_grade is null or blessing_grade >= 0"
                config:
                  severity: warn


      - name: run_id
        description: Ingestion pipeline run identifier.
        tests:
          - not_null

      - name: source_file
        description: Source file name from which the snapshot was ingested.
        tests:
          - not_null

      - name: snapshot_ts
        description: Timestamp when the snapshot was ingested.
        tests:
          - not_null

      - name: snapshot_date
        description: Snapshot business date.
        tests:
          - not_null

      - name: snapshot_version
        description: Version number of the snapshot for a given date.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: "snapshot_version >= 0"
                config:
                  severity: warn

      - name: schema_version
        description: Version of the source schema used during ingestion.
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: "schema_version >= 0"
                config:
                  severity: warn
